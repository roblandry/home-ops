---
# yaml-language-server: $schema=https://crd.movishell.pl/source.toolkit.fluxcd.io/helmrepository_v1.json
apiVersion: source.toolkit.fluxcd.io/v1
kind: HelmRepository
metadata:
  name: stevehipwell
  namespace: monitor
spec:
  type: oci
  url: oci://ghcr.io/stevehipwell/helm-charts
  interval: 1h
  timeout: 3m
---
# yaml-language-server: $schema=https://crd.movishell.pl/helm.toolkit.fluxcd.io/helmrelease_v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: thanos
spec:
  chart:
    spec:
      chart: thanos
      version: 1.20.0
      sourceRef:
        kind: HelmRepository
        name: stevehipwell
        namespace: monitor
  # dependsOn:
  #   - name: kube-prometheus-stack
  interval: 30m
  maxHistory: 3
  uninstall:
    keepHistory: false
  values:
    storeGateway:
      persistence:
        enabled: true
        storageClass: ceph-block
        size: 10Gi
    objstoreConfig:
      create: false
      name: thanos-objectstore-secret
      key: objstore.yaml
      # create: false
      # name: thanos-bucket
      # key: .aws
    additionalEndpoints:
      - dnssrv+_grpc._tcp.kube-prometheus-stack-thanos-discovery.monitor.svc.cluster.local
    additionalReplicaLabels: ["__replica__"]
    serviceMonitor:
      enabled: true
    compact:
      enabled: true
      extraArgs:
        - --compact.concurrency=4
        - --delete-delay=30m
        - --retention.resolution-raw=30d
        - --downsampling.disable
      persistence:
        enabled: true
        storageClass: ceph-block  # or ceph-filesystem if you need RWX
        size: 15Gi
    query:
      extraArgs: # --alert.query-url=http://thanos.${SECRET_DOMAIN}
        - "--alert.query-url=http://thanos.${SECRET_DOMAIN}"
    queryFrontend:
      enabled: true
      # ingress:
      #   enabled: true
      #   ingressClassName: traefik
      #   hosts:
      #     - "thanos.${SECRET_DOMAIN}"

      ingress:
        enabled: true
        ingressClassName: internal
        annotations:
          # external-dns.alpha.kubernetes.io/target: "external.${SECRET_DOMAIN}"
          nginx.ingress.kubernetes.io/custom-http-errors: "401,403,404,500,501,502,503,504,505,506,507,508,510,511"
          gethomepage.dev/app: "thanos"
          gethomepage.dev/enabled: "true"
          gethomepage.dev/name: "Thanos"
          gethomepage.dev/description: "A highly available, long-term storage and querying system for Prometheus metrics"
          gethomepage.dev/href: "https://thanos.${SECRET_DOMAIN}"
          gethomepage.dev/group: "Kubernetes"
          gethomepage.dev/icon: "si-thanos"
        hosts:
          - host: &host "{{ .Release.Name }}.${SECRET_DOMAIN}"
        tls:
          - hosts:
              - *host
            secretName: "${SECRET_DOMAIN/./-}-production-tls"

    # rule:
    #   enabled: true
    #   extraArgs: ["--web.prefix-header=X-Forwarded-Prefix"]
    #   alertmanagersConfig:
    #     value: |-
    #       alertmanagers:
    #         - api_version: v2
    #           static_configs:
    #             - dnssrv+_http-web._tcp.kube-prometheus-stack-alertmanager.monitor.svc.cluster.local
    #   rules:
    #     value: |-
    #       groups:
    #         - name: PrometheusWatcher
    #           rules:
    #             - alert: PrometheusDown
    #               annotations:
    #                 summary: A Prometheus has disappeared from Prometheus target discovery
    #               expr: absent(up{job="prometheus-prometheus"})
    #               for: 5m
    #               labels:
    #                 severity: critical

