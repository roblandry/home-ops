---
# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s-labs/helm-charts/refs/tags/app-template-3.7.3/charts/other/app-template/schemas/helmrelease-helm-v2.schema.json
# # https://hub.docker.com/r/gregewing/apcupsd
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: &app apcupsd
  namespace: &namespace monitor
spec:

  interval: 1h
  chartRef:
    kind: OCIRepository
    name: app-template
  install:
    remediation:
      retries: -1
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  values:
    controllers:
      apcupsd:
        strategy: RollingUpdate
        containers:
          apcupsd:
            image:
              repository: gregewing/apcupsd
              tag: latest@sha256:71b6ede22d73f101ad5dc16e784992ddbc205dcf7328a0e32bfbe93b3c452ba8
            env:
              TZ: ${CONFIG_TIMEZONE}
            securityContext:
              privileged: true
            probes:
              liveness:
                enabled: true
              readiness:
                enabled: true
          # exporter:
          #   image:
          #     repository: ghcr.io/druggeri/nut_exporter
          #     tag: 3.2.0

        pod:
          annotations:
            configmap.reloader.stakater.com/reload: *app

    service:
      apcupsd:
        controller: *app
        ports:
          http:
            port: 3551
            protocol: TCP
      # metrics:
      #   enabled: true
      #   controller: *app
      #   ports:
      #     metrics:
      #       enabled: true
      #       port: 9199
      #       protocol: TCP

    ingress:
      apcupsd:
        enabled: true
        className: external
        annotations:
          external-dns.alpha.kubernetes.io/target: "external.${SECRET_DOMAIN}"
          error-pages.home.arpa/enabled: "true"
          gethomepage.dev/app: *app
          gethomepage.dev/enabled: "true"
          gethomepage.dev/name: "APC UPS Daemon"
          gethomepage.dev/description: "APC UPS Daemon"
          gethomepage.dev/href: "https://apcupsd.${SECRET_DOMAIN}"
          gethomepage.dev/group: "services"
          gethomepage.dev/icon: "sh-apcupsd.png"
        hosts:
          - host: &host "apcupsd.${SECRET_DOMAIN}"
            paths:
              - path: /
                pathType: Prefix
                service:
                  identifier: *app
                  port: http
        tls:
          - hosts:
              - *host
            secretName: "${SECRET_DOMAIN/./-}-production-tls"

    # serviceMonitor:
    #   app:
    #     serviceName: apcupsd-metrics
    #     endpoints:
    #       - port: metrics
    #         scheme: http
    #         interval: 15s
    #         scrapeTimeout: 10s
    #         path: /ups_metrics
    #         params:
    #           target:
    #             - localhost:3551
    #         relabelings:
    #           - sourceLabels: [__param_target]
    #             targetLabel: target

    persistence:
      config:
        type: configMap
        name: apcupsd-config
        defaultMode: 0400
        globalMounts:
          - path: /etc/apcupsd
      # ups:
      #   type: hostPath
      #   hostPath: /dev/bus/usb/001/002
      #   globalMounts:
      #     - path: /dev/bus/usb/001/001
      #       readOnly: false

    configMaps:
      config:
        enabled: true
        data:
          apcupsd.conf: |-
            ## apcupsd.conf v1.1 ##
            UPSCABLE ether
            UPSTYPE pcnet
            DEVICE 10.0.10.15:apc:apcshutdown052581
            LOCKFILE /var/lock
            SCRIPTDIR /etc/apcupsd
            PWRFAILDIR /etc/apcupsd
            NOLOGINDIR /etc
            ONBATTERYDELAY 6
            BATTERYLEVEL 25
            MINUTES 10
            TIMEOUT 0
            ANNOY 300
            ANNOYDELAY 60
            NOLOGON disable
            KILLDELAY 0
            NETSERVER on
            NISIP 0.0.0.0
            NISPORT 3551
            EVENTSFILE /var/log/apcupsd.events
            EVENTSFILEMAX 10
            UPSCLASS standalone
            UPSMODE disable
            STATTIME 0
            STATFILE /var/log/apcupsd.status
            LOGSTATS off
            DATATIME 0
