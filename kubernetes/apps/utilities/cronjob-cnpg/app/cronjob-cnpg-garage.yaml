---
# yaml-language-server: $schema=https://raw.githubusercontent.com/yannh/kubernetes-json-schema/refs/heads/master/v1.33.1/cronjob.json
apiVersion: batch/v1
kind: CronJob
metadata:
  name: &name cnpg-garage
  namespace: utilities
  labels:
    app.kubernetes.io/name: *name
    job-type: backup
spec:
  schedule: "30 0 * * *"
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app.kubernetes.io/name: *name
            job-type: backup
        spec:
          containers:
            - name: rclone
              image: rclone/rclone:latest
              command: ["/bin/sh", "-c"]
              args:
                - |-
                  set -euo pipefail

                  echo "Installing curl..."
                  apk add --no-cache curl

                  echo "Starting rclone sync..."
                  rclone \
                    --rc \
                    --rc-addr=localhost:5572 \
                    --rc-serve-metrics \
                    sync \
                    ceph:cnpg-bucket/ \
                    garage:backup-postgres-16-1/ \
                    --copy-links \
                    --fast-list \
                    --log-level INFO --stats 10s &

                  pid=$!

                  echo "Sleeping briefly to let rclone start RC interface..."
                  sleep 10

                  echo "Pushing metrics to Prometheus Pushgateway..."
                  if ! curl --max-time 5 -s http://localhost:5572/metrics \
                    | curl --max-time 5 --data-binary @- http://prometheus-pushgateway.monitor.svc.cluster.local:9091/metrics/job/cnpg-garage; then
                    echo "⚠️  Failed to push metrics to Pushgateway"
                  fi

                  echo "Waiting for rclone to finish..."
                  wait $pid
                  echo "✅ rclone sync complete"
              env:
                - name: RCLONE_CONFIG
                  value: /config/rclone.conf
              volumeMounts:
                - name: config
                  mountPath: /config
          restartPolicy: OnFailure
          volumes:
            - name: config
              secret:
                secretName: cnpg-rclone-config
