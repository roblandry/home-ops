---
# yaml-language-server: $schema=https://raw.githubusercontent.com/yannh/kubernetes-json-schema/refs/heads/master/v1.33.0/job.json
apiVersion: batch/v1
kind: Job
metadata:
  name: pgloader
  namespace: services
spec:
  completions: 1
  parallelism: 1
  backoffLimit: 0
  template:
    spec:
      annotations:
        reloader.stakater.com/auto: "true"
        secret.reloader.stakater.com/reload: &secret mariadb-to-postgres-migration-secrets
      initContainers:
        # - name: 01-init-db
        #   image: ghcr.io/onedr0p/postgres-init:16
        #   pullPolicy: IfNotPresent
        #   envFrom:
        #     - secretRef:
        #         name: *secret
        - name: pgloader-builder
          image: ubuntu:20.04
          command:
            - /bin/bash
            - -c
            - |
              apt-get update && apt-get install -y \
                git \
                sbcl \
                unzip \
                libsqlite3-dev \
                make \
                curl \
                gawk \
                freetds-dev \
                libzip-dev \
              && rm -rf /var/lib/apt/lists/*

              # Clone pgloader repo and build it
              git clone https://github.com/dimitri/pgloader.git
              cd pgloader
              make DYNSIZE=10240 pgloader

              # Copy the compiled binary to a shared volume
              cp build/bin/pgloader /tmp/pgloader/pgloader
          volumeMounts:
            - name: pgloader-bin
              mountPath: /tmp/pgloader

      containers:
        - name: pgloader
          image: ubuntu:20.04
          command:
            - /bin/bash
            - -c
            - |
              # Install SQLite3 runtime libraries
              apt-get update && apt-get install -y \
                libsqlite3-0 \
              && rm -rf /var/lib/apt/lists/*

              # Copy the pgloader binary from the initContainer and execute migration
              cp /tmp/pgloader/pgloader /root/pgloader
              /root/pgloader --verbose --debug /tmp/myload/my.load
          resources:
            requests:
              memory: "10Gi"
              cpu: "1"
            limits:
              memory: "20Gi"
              cpu: "2"
          volumeMounts:
            - name: pgloader-bin
              mountPath: /tmp/pgloader
            - name: config-volume
              mountPath: /tmp/myload
      volumes:
        - name: pgloader-bin
          emptyDir: {}
        - name: config-volume
          configMap:
            name: myload
            items:
              - key: my.load
                path: my.load
      restartPolicy: Never
